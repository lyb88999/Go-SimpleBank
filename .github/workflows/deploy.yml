# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Deploy to production

on:
  push:
    branches: [ "main" ]


jobs:

  build:
    name: Build image
    runs-on: ubuntu-latest
    steps:
      - name: Login to ACR
        uses: aliyun/acr-login@v1
        with:
          region-id: 'cn-hangzhou' # example: cn-hangzhou
          access-key-id: ${{secrets.ACR_ACCESS_KEY_ID}}
          access-key-secret: ${{secrets.ACR_ACCESS_KEY_SECRET}}

      - name: Build and push image
        env:
          ACR_REGISTRY: steps.acr-login.outputs.acr-registry
          ACR_REPOSITORY: simplebank
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ACR_REGISTRY/$ACR_REPOSITORY:$IMAGE_TAG .
          docker push $ACR_REGISTRY/$ACR_REPOSITORY:$IMAGE_TAG